<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Private Site Editor</title>
  <script>
    if (window.self !== window.top) {
      window.location.replace('index.html');
    }
  </script>
  <style>
    :root { --bg:#0c0d10; --panel:#15171d; --muted:#9aa1b2; --text:#eef2ff; --border:#2c313d; --accent:#9ea7ff; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:Inter,system-ui,sans-serif; background:var(--bg); color:var(--text); }
    .hidden { display:none !important; }
    .gate { max-width:420px; margin:14vh auto; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:1rem; }

    .shell { display:grid; grid-template-columns:460px 1fr; gap:1rem; min-height:100vh; padding:1rem; }
    .shell.collapsed { grid-template-columns:320px 1fr; }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:0.9rem; overflow:auto; max-height:calc(100vh - 2rem); }
    .preview { border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#050505; min-height:calc(100vh - 2rem); }

    h1 { font-size:1.08rem; margin:.1rem 0; }
    h2 { margin:0 0 .5rem; font-size:.8rem; text-transform:uppercase; letter-spacing:.08em; color:var(--muted); }
    .muted { color:var(--muted); font-size:.84rem; }
    .actions { display:flex; gap:.45rem; flex-wrap:wrap; margin-top:.55rem; }
    button { border:1px solid var(--border); border-radius:8px; background:#11141d; color:var(--text); padding:.5rem .7rem; cursor:pointer; }
    button.primary { background:var(--accent); color:#111; border-color:transparent; font-weight:700; }
    .section { margin-top:1rem; border-top:1px solid var(--border); padding-top:.8rem; }
    .field { border:1px solid var(--border); border-radius:9px; padding:.55rem; margin-bottom:.55rem; background:#11131a; }
    .label { display:block; font-size:.72rem; letter-spacing:.07em; text-transform:uppercase; color:var(--muted); margin-bottom:.3rem; }
    input, textarea { width:100%; background:#0d0f14; border:1px solid var(--border); color:var(--text); border-radius:7px; padding:.45rem .6rem; }
    textarea { min-height:70px; resize:vertical; }
    .size { display:grid; grid-template-columns:1fr auto; gap:.45rem; align-items:center; margin-top:.45rem; }
    input[type='range'] { width:100%; accent-color:var(--accent); }
    .pill { border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:.72rem; padding:.2rem .45rem; min-width:64px; text-align:center; }
    .project-card-editor { border:1px solid var(--border); border-radius:10px; padding:.6rem; margin-bottom:.6rem; background:#10131b; }
    .project-header { display:flex; justify-content:space-between; align-items:center; gap:.5rem; margin-bottom:.5rem; }
    .project-title { font-size:.86rem; font-weight:700; }
    .drag-handle { cursor:grab; color:var(--muted); user-select:none; }
    .project-row { display:grid; grid-template-columns: 1fr 1fr; gap:.4rem; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; gap:.7rem; }
    iframe { width:100%; height:100%; border:0; }
    pre { white-space:pre-wrap; max-height:220px; overflow:auto; margin:.7rem 0 0; background:#0d0f14; border:1px solid var(--border); border-radius:8px; padding:.7rem; font-size:.75rem; }
    @media (max-width: 1200px) { .shell { grid-template-columns:1fr; } .preview { min-height:65vh; } .panel { max-height:none; } }
  </style>
</head>
<body>
  <div id="gate" class="gate">
    <h1>Private editor</h1>
    <p class="muted">Unlock your CMS panel for live editing, previewing, and publishing.</p>
    <label class="label" for="key">Editor key</label>
    <input id="key" type="password" />
    <div class="actions"><button id="unlock" class="primary">Unlock</button></div>
  </div>

  <main id="app" class="shell hidden">
    <section id="cmsPanel" class="panel">
      <div class="toolbar">
        <h1>Portfolio CMS</h1>
        <button id="togglePanelBtn">Wider preview</button>
      </div>
      <p class="muted">Live preview updates while typing. Save persists state. Apply/Download publishes to real file.</p>

      <div class="actions">
        <button id="saveBtn" class="primary">Save edits</button>
        <button id="applyFileBtn">Apply to index.html file</button>
        <button id="downloadIndexBtn">Download updated index.html</button>
        <button id="resetBtn">Reset defaults</button>
        <button id="openSiteBtn">Open site</button>
        <button id="inlineToggleBtn">Inline edit preview text</button>
        <button id="addProjectBtn">Add project</button>
        <span id="saveStatus" class="muted" style="align-self:center;">Ready</span>
      </div>

      <div class="section">
        <h2>Site text</h2>
        <div id="siteFields"></div>
      </div>

      <div class="section">
        <h2>Work items (drag to reorder)</h2>
        <div id="projectFields"></div>
      </div>

      <pre id="output"></pre>
    </section>

    <section class="preview">
      <iframe id="preview" src="index.html"></iframe>
    </section>
  </main>

  <script>
    const EDITOR_KEY = 'mrm-private-editor';
    const EDITOR_STATE_KEY = 'mrm_editor_state_v1';
    const INDEX_URL = new URL('index.html', window.location.href).toString();

    const gate = document.getElementById('gate');
    const app = document.getElementById('app');
    const keyInput = document.getElementById('key');
    const preview = document.getElementById('preview');
    const saveStatus = document.getElementById('saveStatus');
    const projectFields = document.getElementById('projectFields');
    const editorChannel = typeof BroadcastChannel !== 'undefined' ? new BroadcastChannel('mrm_editor_channel') : null;

    let inlineEditEnabled = false;
    let dragSourceKey = null;

    preview.src = INDEX_URL;

    let state = { siteContent: {}, projectContent: {} };

    function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }

    function defaultStateFromSnapshot(snapshot) {
      return {
        siteContent: snapshot.siteContent || {},
        projectContent: snapshot.projectContent || {}
      };
    }

    function parseVimeo(value) {
      if (typeof value !== 'string') return value;
      const parts = value.split(',').map(v => v.trim()).filter(Boolean);
      const ids = parts.map((part) => {
        const m = part.match(/(?:vimeo\.com\/(?:video\/)?)(\d+)/i);
        return m ? m[1] : part;
      });
      return ids.length > 1 ? ids.join(', ') : (ids[0] || '');
    }

    function normalizeProject(project, fallbackOrder = 0) {
      return {
        title: project.title || 'Untitled Project',
        category: project.category || '',
        role: project.role || '',
        year: project.year || '',
        studio: project.studio || '',
        deliverables: project.deliverables || '',
        description: project.description || '',
        file: project.file || '',
        vimeo: typeof project.vimeo === 'string' ? project.vimeo : Array.isArray(project.vimeo) ? project.vimeo.join(', ') : '',
        frames: typeof project.frames === 'string' ? project.frames : Array.isArray(project.frames) ? project.frames.join(', ') : '',
        order: Number.isFinite(Number(project.order)) ? Number(project.order) : fallbackOrder,
        deleted: !!project.deleted
      };
    }

    function loadSavedState() {
      try {
        const parsed = JSON.parse(localStorage.getItem(EDITOR_STATE_KEY) || '{}');
        if (parsed.siteContent && parsed.projectOverrides) {
          state.siteContent = parsed.siteContent;
          state.projectContent = Object.fromEntries(
            Object.entries(parsed.projectOverrides).map(([k, v], i) => [k, normalizeProject(v, i)])
          );
        }
      } catch {}
    }

    function saveState(status = 'Saved') {
      localStorage.setItem(EDITOR_STATE_KEY, JSON.stringify({
        siteContent: state.siteContent,
        projectOverrides: state.projectContent
      }));
      if (saveStatus) saveStatus.textContent = status;
    }

    function broadcastState() {
      if (!editorChannel) return;
      editorChannel.postMessage({
        type: 'editor-state-update',
        payload: { siteContent: state.siteContent, projectOverrides: state.projectContent }
      });
    }

    function postPreviewUpdate() {
      try {
        preview.contentWindow.postMessage({
          type: 'portfolio-preview-update',
          payload: { siteContent: state.siteContent, projectOverrides: state.projectContent }
        }, '*');
      } catch {}
    }

    function renderOutput() {
      document.getElementById('output').textContent =
`let siteContent = ${JSON.stringify(state.siteContent, null, 2)};\n\nlet projectContentOverrides = ${JSON.stringify(state.projectContent, null, 2)};`;
    }

    function pushAll(status='Saved') {
      saveState(status);
      renderOutput();
      postPreviewUpdate();
      broadcastState();
    }

    function makeSiteField(id, value) {
      const box = document.createElement('div');
      box.className = 'field';
      box.innerHTML = `<label class="label">${id}</label>`;

      const input = document.createElement('textarea');
      input.value = value.text || '';
      input.addEventListener('input', () => {
        state.siteContent[id].text = input.value;
        pushAll('Saving…');
      });

      const row = document.createElement('div');
      row.className = 'size';
      const range = document.createElement('input');
      range.type = 'range';
      range.min = '0.55';
      range.max = '8';
      range.step = '0.05';
      range.value = String(value.size || 1);
      const pill = document.createElement('span');
      pill.className = 'pill';
      pill.textContent = `${range.value}rem`;
      range.addEventListener('input', () => {
        state.siteContent[id].size = Number(range.value);
        pill.textContent = `${Number(range.value).toFixed(2).replace(/\.00$/, '')}rem`;
        pushAll('Saving…');
      });
      row.append(range, pill);
      box.append(input, row);
      return box;
    }

    function sortedProjectEntries() {
      return Object.entries(state.projectContent)
        .sort((a, b) => Number(a[1].order || 0) - Number(b[1].order || 0));
    }

    function updateProjectOrder(keys) {
      keys.forEach((key, idx) => {
        if (!state.projectContent[key]) return;
        state.projectContent[key].order = idx;
      });
      pushAll('Saved');
      renderProjectFields();
    }

    function moveProject(key, dir) {
      const keys = sortedProjectEntries().map(([k]) => k);
      const i = keys.indexOf(key);
      const j = i + dir;
      if (i < 0 || j < 0 || j >= keys.length) return;
      [keys[i], keys[j]] = [keys[j], keys[i]];
      updateProjectOrder(keys);
    }

    function makeField(labelText, value, onInput, type='text') {
      const label = document.createElement('label');
      label.className = 'label';
      label.textContent = labelText;
      const input = document.createElement(type === 'textarea' ? 'textarea' : 'input');
      if (type !== 'textarea') input.type = type;
      input.value = value ?? '';
      input.addEventListener('input', () => onInput(input.value));
      return [label, input];
    }

    function makeProjectCard(projectKey, project) {
      const card = document.createElement('div');
      card.className = 'project-card-editor';
      card.draggable = true;
      card.dataset.key = projectKey;

      card.addEventListener('dragstart', () => { dragSourceKey = projectKey; card.style.opacity = '0.5'; });
      card.addEventListener('dragend', () => { card.style.opacity = '1'; });
      card.addEventListener('dragover', (e) => e.preventDefault());
      card.addEventListener('drop', (e) => {
        e.preventDefault();
        if (!dragSourceKey || dragSourceKey === projectKey) return;
        const keys = sortedProjectEntries().map(([k]) => k);
        const from = keys.indexOf(dragSourceKey);
        const to = keys.indexOf(projectKey);
        keys.splice(to, 0, keys.splice(from, 1)[0]);
        updateProjectOrder(keys);
      });

      const header = document.createElement('div');
      header.className = 'project-header';
      header.innerHTML = `<div class="project-title">${project.title}</div><div class="drag-handle">⠿ drag</div>`;

      const actions = document.createElement('div');
      actions.className = 'actions';
      const up = document.createElement('button'); up.textContent = 'Move up'; up.type='button'; up.onclick = () => moveProject(projectKey, -1);
      const down = document.createElement('button'); down.textContent = 'Move down'; down.type='button'; down.onclick = () => moveProject(projectKey, 1);
      const del = document.createElement('button'); del.textContent = project.deleted ? 'Restore' : 'Delete'; del.type='button';
      del.onclick = () => { state.projectContent[projectKey].deleted = !state.projectContent[projectKey].deleted; pushAll('Saved'); renderProjectFields(); };
      actions.append(up, down, del);

      const body = document.createElement('div');
      body.className = 'project-row';

      const fields = [
        ['title', 'text'], ['category', 'text'], ['role', 'text'], ['year', 'text'], ['studio', 'text'],
        ['deliverables', 'text'], ['description', 'textarea'], ['file', 'text'], ['vimeo', 'text'], ['frames', 'text'], ['order', 'number']
      ];

      fields.forEach(([key, type]) => {
        const [label, input] = makeField(key, project[key], (val) => {
          state.projectContent[projectKey][key] = key === 'order' ? Number(val || 0) : (key === 'vimeo' ? parseVimeo(val) : val);
          pushAll('Saving…');
          if (key === 'order') renderProjectFields();
        }, type);
        body.append(label, input);
      });

      card.append(header, actions, body);
      if (project.deleted) card.style.opacity = '0.5';
      return card;
    }

    function renderProjectFields() {
      projectFields.innerHTML = '';
      sortedProjectEntries().forEach(([key, value]) => {
        projectFields.appendChild(makeProjectCard(key, value));
      });
    }

    function renderForms() {
      const siteRoot = document.getElementById('siteFields');
      siteRoot.innerHTML = '';
      Object.entries(state.siteContent).forEach(([id, value]) => siteRoot.appendChild(makeSiteField(id, value)));
      renderProjectFields();
      pushAll('Saved');
    }

    function setInlineEditable(doc, id, enabled) {
      const el = doc.getElementById(id);
      if (!el) return;
      el.contentEditable = enabled ? 'true' : 'false';
      el.style.outline = enabled ? '1px dashed #8ea0ff' : '';
      if (!enabled) return;
      el.oninput = () => {
        if (!state.siteContent[id]) return;
        state.siteContent[id].text = el.innerHTML;
        pushAll('Saving…');
      };
    }

    function setInlineProjectEditable(doc, enabled) {
      const titles = doc.querySelectorAll('.project-card .card-title');
      titles.forEach((node) => {
        const key = node.closest('.project-card')?.dataset?.projectKey;
        if (!key || !state.projectContent[key]) return;
        node.contentEditable = enabled ? 'true' : 'false';
        node.style.outline = enabled ? '1px dashed #8ea0ff' : '';
        if (!enabled) return;
        node.oninput = () => {
          state.projectContent[key].title = node.innerText;
          pushAll('Saving…');
          renderProjectFields();
        };
      });
    }

    function toggleInlineEdit() {
      const doc = preview.contentDocument;
      if (!doc) { alert('Preview not ready yet.'); return; }
      inlineEditEnabled = !inlineEditEnabled;
      Object.keys(state.siteContent).forEach((id) => setInlineEditable(doc, id, inlineEditEnabled));
      setInlineProjectEditable(doc, inlineEditEnabled);
      document.getElementById('inlineToggleBtn').textContent = inlineEditEnabled ? 'Disable inline edit' : 'Inline edit preview text';
    }

    function buildUpdatedIndexHtml(sourceHtml) {
      const nextSite = `let siteContent = ${JSON.stringify(state.siteContent, null, 2)};`;
      const nextProjects = `let projectContentOverrides = ${JSON.stringify(state.projectContent, null, 2)};`;
      let updated = sourceHtml.replace(/let\s+siteContent\s*=\s*\{[\s\S]*?\};/, nextSite);
      updated = updated.replace(/let\s+projectContentOverrides\s*=\s*\{[\s\S]*?\};/, nextProjects);
      return updated;
    }

    async function fetchCurrentIndexHtml() {
      const res = await fetch(INDEX_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('Could not load index.html');
      return await res.text();
    }

    function downloadTextFile(filename, text) {
      const blob = new Blob([text], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function hydrateFromPreview() {
      const snapshotFn = preview.contentWindow?.getPortfolioEditorSnapshot;
      if (typeof snapshotFn !== 'function') return;
      const snap = snapshotFn();
      state = defaultStateFromSnapshot(snap);
      state.projectContent = Object.fromEntries(Object.entries(state.projectContent).map(([k, v], i) => [k, normalizeProject(v, i)]));
      renderForms();
    }

    function unlockEditor() {
      if (keyInput.value !== EDITOR_KEY) { alert('Incorrect key.'); return; }
      sessionStorage.setItem('editorUnlocked', '1');
      loadSavedState();
      gate.classList.add('hidden');
      app.classList.remove('hidden');
      renderForms();
    }

    document.getElementById('unlock').addEventListener('click', unlockEditor);

    preview.addEventListener('load', async () => {
      await hydrateFromPreview();
      postPreviewUpdate();
    });

    if (sessionStorage.getItem('editorUnlocked') === '1') {
      loadSavedState();
      gate.classList.add('hidden');
      app.classList.remove('hidden');
      renderForms();
    }

    document.getElementById('saveBtn').addEventListener('click', () => {
      pushAll('Saved');
      alert('Saved locally and pushed live to preview/open tabs.');
    });

    document.getElementById('applyFileBtn').addEventListener('click', async () => {
      if (!window.showOpenFilePicker) {
        alert('Direct file apply is not supported in this browser. Use Download updated index.html instead.');
        return;
      }
      try {
        const [fileHandle] = await window.showOpenFilePicker({
          types: [{ description: 'HTML Files', accept: { 'text/html': ['.html'] } }], multiple: false
        });
        const file = await fileHandle.getFile();
        const updated = buildUpdatedIndexHtml(await file.text());
        const writable = await fileHandle.createWritable();
        await writable.write(updated); await writable.close();
        saveStatus.textContent = 'Applied to file';
      } catch (error) {
        if (error?.name !== 'AbortError') alert(`Apply failed: ${error.message}`);
      }
    });

    document.getElementById('downloadIndexBtn').addEventListener('click', async () => {
      try {
        const updated = buildUpdatedIndexHtml(await fetchCurrentIndexHtml());
        downloadTextFile('index.html', updated);
        saveStatus.textContent = 'Downloaded index.html';
      } catch (error) {
        alert(`Download failed: ${error.message}`);
      }
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      localStorage.removeItem(EDITOR_STATE_KEY);
      preview.contentWindow?.localStorage?.removeItem(EDITOR_STATE_KEY);
      window.location.reload();
    });

    document.getElementById('openSiteBtn').addEventListener('click', () => window.open(INDEX_URL, '_blank'));
    document.getElementById('inlineToggleBtn').addEventListener('click', toggleInlineEdit);
    document.getElementById('addProjectBtn').addEventListener('click', () => {
      const key = `custom:${Date.now()}`;
      state.projectContent[key] = normalizeProject({ title: 'New Project', file: '', vimeo: '', frames: '', order: Object.keys(state.projectContent).length }, Object.keys(state.projectContent).length);
      renderForms();
    });

    document.getElementById('togglePanelBtn').addEventListener('click', () => {
      app.classList.toggle('collapsed');
      const collapsed = app.classList.contains('collapsed');
      document.getElementById('togglePanelBtn').textContent = collapsed ? 'Wider panel' : 'Wider preview';
    });
  </script>
</body>
</html>
